---
- hosts:
    - all
    - localhost
  become: true
  become_user: root
  become_method: sudo
  vars:
    domain: localhost
    http_port: 9999
    project_root: /vagrant
    project_dir: /vagrant/ngt_archive
  vars_files:
    - main.yml

  tasks:
      - name: update apt cache
        apt: update_cache=yes
      - name: Install Python and Sqlite3 Packages
        apt: name={{ item }} state=present
        with_items:
          - git
          - python-setuptools
          - python3-pip
          - python-virtualenv
          - uwsgi-plugin-python3
          - python3-dev
          - sqlite3
          - libsqlite3-dev
          - libldap2-dev
          - libsasl2-dev
          - libssl-dev
        tags:
          - base
          - python
          - app

      - name: Create a local settings file in {{ project_dir }}
        template: src=settings_local_py.jinja2
                  dest={{ project_dir }}/local.py
        tags:
         - app
         - manage

      - name: Install virtualenv for python 3
        pip: executable=/usr/bin/pip3 name={{ item }}
        with_items:
          - uwsgi
          - virtualenv

      - name: Create a virtual environment
        pip: name={{ item }} virtualenv={{ project_root }}/.venv virtualenv_python=/usr/bin/python3.4 chdir={{ project_root }}
        with_items:
            - django
            - -e .
        tags:
         - app
         - manage

#      # Migrate DB
#      - name: Django migrate DB
#        django_manage:
#          command=migrate
#          app_path={{ project_root }}
#          virtualenv={{ project_root }}/.venv
#          pythonpath={{ project_root }}:{{ project_root }}/.venv/lib/python3.4/site-packages
#        environment:
#          PYTHONPATH: "{{ project_root }}:{{ project_root }}/.venv/lib/python3.4/site-packages"
#        tags:
#         - app
#         - manage

      # Collect static
      - name: Django collectstaic
        django_manage:
          command=collectstatic
          app_path={{ project_root }}
          virtualenv={{ project_root }}/.venv
          pythonpath={{ project_root }}:{{ project_root }}/.venv/lib/python3.4/site-packages
        environment:
          PYTHONPATH: "{{ project_root }}:{{ project_root }}/.venv/lib/python3.4/site-packages"
        tags:
         - app
         - manage


      - name: ngt_archive uwsgi app conf
        template: src=ngt_archive_init.jinja2 dest=/etc/init/ngt_archive.conf
        notify: restart ngt_archive
        tags:
         - app


  handlers:
      - name: restart ngt_archive
        service: name=ngt_archive state=restarted

